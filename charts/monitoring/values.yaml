# Monitoring Stack Configuration
# This wraps kube-prometheus-stack with our custom settings

# Ingress hostname (must match the main ingress chart's host value)
ingress:
  host: ticker

# Grafana admin password (stored as a Kubernetes Secret, not passed as plaintext)
grafanaAdminPassword: ticker

kube-prometheus-stack:
  # ── Grafana ──────────────────────────────────────────────
  grafana:
    enabled: true
    adminUser: admin
    admin:
      existingSecret: grafana-admin-secret
      passwordKey: admin-password

    service:
      type: ClusterIP

    # Serve Grafana from /grafana/ sub-path (behind Ingress)
    grafana.ini:
      server:
        root_url: "%(protocol)s://%(domain)s/grafana/"
        serve_from_sub_path: true

    sidecar:
      dashboards:
        enabled: true
        label: grafana_dashboard

    # Pre-configure datasources for Grafana
    additionalDataSources:
      - name: Prometheus
        type: prometheus
        access: proxy
        url: http://monitoring-kube-prometheus-prometheus.monitoring.svc.cluster.local:9090
        uid: prometheus
        isDefault: true
        jsonData:
          timeInterval: 15s
      - name: InfluxDB
        type: influxdb
        access: proxy
        url: http://influxdb-service.default.svc.cluster.local:8086
        jsonData:
          version: Flux
          organization: ticker
          defaultBucket: ticks
        secureJsonData:
          token: ticker-secret-token
      - name: Loki
        type: loki
        access: proxy
        url: http://loki.monitoring.svc.cluster.local:3100
        jsonData:
          maxLines: 1000

    resources:
      requests:
        cpu: "100m"
        memory: "256Mi"
      limits:
        cpu: "500m"
        memory: "512Mi"

  # ── Prometheus ───────────────────────────────────────────
  prometheus:
    prometheusSpec:
      retention: 24h
      scrapeInterval: 15s

      resources:
        requests:
          cpu: "200m"
          memory: "512Mi"
        limits:
          cpu: "1000m"
          memory: "1Gi"

      # Minimal storage for single-node k3s
      storageSpec:
        volumeClaimTemplate:
          spec:
            accessModes: ["ReadWriteOnce"]
            resources:
              requests:
                storage: 2Gi

  # ── Disable heavy components not needed for single-node ──
  alertmanager:
    enabled: false

  # Node exporter for hardware metrics (CPU, RAM, disk)
  nodeExporter:
    enabled: true

  kubeStateMetrics:
    enabled: true

  # Disable components that don't work well on k3s
  kubeEtcd:
    enabled: false
  kubeControllerManager:
    enabled: false
  kubeScheduler:
    enabled: false
  kubeProxy:
    enabled: false
