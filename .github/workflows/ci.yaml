name: CI/CD

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  lint-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: v3.11.1

      - name: Lint Ticker App
        run: helm lint charts/ticker-app/

      - name: Lint NATS
        run: helm lint charts/nats/

      - name: Lint InfluxDB
        run: helm lint charts/influxdb/

      - name: Trivy - Scan Container Images
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'node:18-alpine'
          format: 'table'
          exit-code: '1'
          severity: 'CRITICAL'

      # In a real pipeline, you'd also run:
      # - helm test (needs a k8s cluster, e.g. using kind-action)
      # - docker build & push (needs credentials)
      # - git tag & push (to trigger Argo CD)
